<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Grist Leaflet Heatmap</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style> html, body, #map { height:100%; margin:0; padding:0; } </style>
</head>
<body>
  <div id="map"></div>

  <!-- libs -->
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat@0.3.0/dist/leaflet-heat.js"></script>

  <script>
  // Set up map
  const map = L.map('map').setView([32.806671, -86.791130], 7);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19, attribution: '© OpenStreetMap contributors'
  }).addTo(map);

  let heatLayer;

  // tolerant accessor for latitude & longitude (handles many column name styles)
  function getLatLonFromRow(row, mappings) {
    if (mappings && mappings.lat && mappings.lon) {
      const lat = row[mappings.lat];
      const lon = row[mappings.lon];
      if (Number.isFinite(lat) && Number.isFinite(lon)) {
        return [lat, lon];
      }
    }
    // try many common keys (case-sensitive keys as Grist sends them)
    const latKeys = ['Lat','LAT','lat','Latitude','LATITUDE','latitude'];
    const lonKeys = ['Lng','LNG','lng','Lon','LON','lon','Longitude','LONGITUDE','longitude'];
    let lat = null, lon = null;
    for (const k of latKeys) { if (k in row && row[k] != null) { lat = parseFloat(row[k]); break; } }
    for (const k of lonKeys) { if (k in row && row[k] != null) { lon = parseFloat(row[k]); break; } }
    if (Number.isFinite(lat) && Number.isFinite(lon)) return [lat, lon];
    return null;
  }

  function renderHeat(records, mappings) {
    console.log("renderHeat called; records length:", records?.length ?? 0);
    const points = [];
    if (!records || !records.length) {
      console.log("No records to render.");
    } else {
      // Show example of first few rows for debugging
      console.log("First 5 records preview:", records.slice(0,5));
      for (const r of records) {
        const pair = getLatLonFromRow(r, mappings);
        if (pair) points.push([pair[0], pair[1], 1]); // weight=1 for each row
      }
      console.log("Parsed points count:", points.length);
    }

    if (heatLayer) { try { map.removeLayer(heatLayer); } catch(e){} }
    if (!points.length) return;

    heatLayer = L.heatLayer(points, { radius: 25, blur: 15, maxZoom: 17 }).addTo(map);

    // fit bounds safely (if only one point, expand a small box)
    try {
      if (points.length === 1) {
        const p = points[0];
        const pad = 0.1;
        map.fitBounds([[p[0]-pad, p[1]-pad],[p[0]+pad, p[1]+pad]], { padding: [30,30] });
      } else {
        map.fitBounds(points.map(p => [p[0], p[1]]), { padding: [30,30] });
      }
    } catch (err) {
      console.warn("fitBounds failed:", err);
    }
  }

  // Connect to Grist — request read access and request the likely column names.
  grist.ready({
    requiredAccess: 'read table',
    columns: [
      { name: "lat", type: 'Numeric', title: 'Latitude', optional: true },
      { name: "lon", type: 'Numeric', title: 'Longitude', optional: true }
    ]
  });

  // Debug: log mapping info when plugin attaches
  grist.onReady((info) => {
    console.log("Grist widget ready. Info:", info);
    // info contains availableTables / selected table metadata in some environments
  });

  // Main listener: whenever records change, render heat
  grist.onRecords((records, mappings) => {
    // records is an array of objects where keys are column IDs (exact names in Grist)
    console.log("onRecords invoked. mappings:", mappings);
    console.log("Raw records received:", JSON.stringify(records, null, 2));
    renderHeat(records || [], mappings);
  });

  </script>
</body>
</html>
